<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ネオン・ヒーロー - 賑やか日本語版</title>
    <style>
        :root {
            --bg-dark: #050510;
            --lane-bg: rgba(20, 20, 40, 0.4);
            --neon-cyan: #00f2ff;
            --neon-pink: #ff007a;
            --neon-lime: #bcff00;
            --neon-purple: #9d00ff;
            --text-color: #ffffff;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-color);
            font-family: 'Exo 2', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 100%;
            max-height: 850px;
            background: radial-gradient(circle at center, #1a1a3a 0%, #050510 100%);
            box-shadow: 0 0 100px rgba(0, 242, 255, 0.2);
            overflow: hidden;
        }

        /* アニメーション付きグリッド背景 */
        .grid-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: center top;
            perspective: 500px;
            z-index: 1;
        }

        .grid-bg-inner {
            width: 100%; height: 200%;
            background-image: inherit;
            background-size: inherit;
            transform: rotateX(60deg) translateY(-25%);
            animation: grid-scroll 10s linear infinite;
        }

        @keyframes grid-scroll {
            from { background-position: 0 0; }
            to { background-position: 0 400px; }
        }

        #bg-video, #youtube-player-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            opacity: 0.5;
            pointer-events: none;
        }

        canvas {
            position: relative;
            display: block;
            width: 100%; height: 100%;
            z-index: 5;
        }

        /* UI スタイル */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        .score-display {
            margin-top: 40px;
            font-size: 28px;
            font-weight: 900;
            letter-spacing: 2px;
            color: var(--neon-cyan);
            text-shadow: 0 0 15px var(--neon-cyan), 0 0 5px white;
        }

        .combo-display {
            position: absolute;
            top: 35%;
            font-size: 64px;
            font-weight: 900;
            color: var(--neon-pink);
            text-shadow: 0 0 30px var(--neon-pink);
            opacity: 0;
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .judgment-display {
            position: absolute;
            top: 52%;
            font-size: 38px;
            font-weight: 900;
            text-transform: uppercase;
            font-style: italic;
            letter-spacing: 4px;
        }

        /* スクリーン */
        #start-screen, #result-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 20, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 30px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .btn {
            padding: 12px 35px;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            background: linear-gradient(45deg, var(--neon-pink), var(--neon-purple));
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(255, 0, 122, 0.4);
            margin: 8px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 0, 122, 0.6);
        }

        .btn:disabled { background: #333; cursor: not-allowed; opacity: 0.5; box-shadow: none; }

        .input-group {
            margin: 10px 0;
            width: 100%;
            max-width: 350px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 20px;
            border: 1px solid rgba(0, 242, 255, 0.2);
        }

        input[type="text"] {
            width: 90%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #444;
            background: rgba(0,0,0,0.5);
            color: var(--neon-cyan);
            margin-bottom: 10px;
            text-align: center;
        }

        /* 難易度セレクター */
        .diff-selector {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 5px;
        }

        .diff-btn {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
        }

        .diff-btn.active[data-diff="easy"] { background: var(--neon-lime); color: black; border-color: var(--neon-lime); box-shadow: 0 0 10px var(--neon-lime); }
        .diff-btn.active[data-diff="normal"] { background: var(--neon-cyan); color: black; border-color: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); }
        .diff-btn.active[data-diff="hard"] { background: var(--neon-pink); color: white; border-color: var(--neon-pink); box-shadow: 0 0 10px var(--neon-pink); }
        .diff-btn.active[data-diff="expert"] { background: var(--neon-purple); color: white; border-color: var(--neon-purple); box-shadow: 0 0 10px var(--neon-purple); }

        /* 操作エリア */
        #touch-controls {
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 160px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            z-index: 20;
        }

        .touch-btn {
            background: linear-gradient(to bottom, transparent, rgba(0, 242, 255, 0.05));
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: rgba(255, 255, 255, 0.2);
            transition: all 0.1s;
            user-select: none;
        }

        .touch-btn.active {
            background: rgba(0, 242, 255, 0.2);
            color: var(--neon-cyan);
            text-shadow: 0 0 15px var(--neon-cyan);
            border-top: 3px solid var(--neon-cyan);
        }

        /* アニメーションとユーティリティ */
        .hidden { display: none !important; }
        .loader {
            border: 4px solid #333;
            border-top: 4px solid var(--neon-cyan);
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .toast {
            position: fixed; top: 20px; background: var(--neon-purple);
            color: white; padding: 12px 25px; border-radius: 30px;
            z-index: 200; box-shadow: 0 0 20px var(--neon-purple);
        }
    </style>
</head>
<body>

<div id="game-container">
    <!-- ビジュアル背景レイヤー -->
    <div class="grid-bg"><div class="grid-bg-inner"></div></div>
    <video id="bg-video" playsinline class="hidden"></video>
    <div id="youtube-player-container" class="hidden"><div id="yt-player"></div></div>
    
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-layer">
        <div class="score-display">スコア: <span id="score-val">000000</span></div>
        <div id="combo-text" class="combo-display">0</div>
        <div id="judgment-text" class="judgment-display"></div>
    </div>

    <!-- 矢印操作パネル -->
    <div id="touch-controls">
        <div class="touch-btn" id="btn-0" data-key="ArrowLeft">←</div>
        <div class="touch-btn" id="btn-1" data-key="ArrowDown">↓</div>
        <div class="touch-btn" id="btn-2" data-key="ArrowUp">↑</div>
        <div class="touch-btn" id="btn-3" data-key="ArrowRight">→</div>
    </div>

    <!-- メニュー画面 -->
    <div id="start-screen">
        <h1 style="font-size: 36px; margin-bottom: 5px; background: linear-gradient(to bottom, #fff, var(--neon-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 10px var(--neon-cyan));">ネオン・ヒーロー</h1>
        <p style="color: #888; margin-top: 0; letter-spacing: 4px; font-size: 12px;">RHYTHM ACTION</p>
        
        <div class="input-group">
            <input type="file" id="media-upload" accept="audio/*,video/*" style="display: none;">
            <button class="btn" style="background: #222; width: 100%; border: 1px solid #444; font-size: 14px;" onclick="document.getElementById('media-upload').click()">ローカルファイルを選択</button>
            <div id="file-name" style="font-size: 11px; color: var(--neon-lime); margin-top: 5px; text-align: center;">MP3 または MP4 を選択</div>
        </div>

        <div class="input-group">
            <input type="text" id="yt-url" placeholder="YouTubeのURLを貼り付け...">
            <div style="display: flex; gap: 8px;">
                <button class="btn" id="yt-load-btn" style="background: #333; margin: 0; flex: 1; font-size: 12px;">読み込む</button>
                <button class="btn hidden" id="yt-share-btn" style="background: var(--neon-purple); margin: 0; flex: 1; font-size: 12px;">共有</button>
            </div>
            <div id="yt-status" style="font-size: 11px; color: var(--neon-pink); margin-top: 5px; height: 14px;"></div>
        </div>

        <div class="input-group">
            <p style="font-size: 12px; margin: 0 0 8px 0; color: #aaa;">難易度設定</p>
            <div class="diff-selector" id="diff-selector">
                <button class="diff-btn" data-diff="easy">かんたん</button>
                <button class="diff-btn active" data-diff="normal">ふつう</button>
                <button class="diff-btn" data-diff="hard">むずかしい</button>
                <button class="diff-btn" data-diff="expert">おに</button>
            </div>
        </div>

        <button class="btn" id="start-btn" disabled>準備完了</button>
        <div style="margin-top: 10px; font-size: 10px; color: #666; line-height: 1.4;">
            PC: 矢印キー [←][↓][↑][→] | スマホ: 画面下の矢印
        </div>
        <div id="origin-warning" class="hidden" style="color: var(--neon-lime); font-size: 10px; margin-top: 5px;">
            注意: ローカルファイル実行時はYouTube再生が制限される場合があります。
        </div>
    </div>

    <!-- リザルト画面 -->
    <div id="result-screen" class="hidden">
        <h2 style="font-size: 32px; color: var(--neon-cyan);">ステージクリア！</h2>
        <div style="font-size: 56px; margin: 10px 0; color: #fff; text-shadow: 0 0 20px var(--neon-cyan);" id="final-score">0</div>
        <div id="stats-detail" style="text-align: center; margin-bottom: 25px; line-height: 1.6; color: #aaa;"></div>
        <button class="btn" id="retry-btn">メニューに戻る</button>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
/**
 * ネオン・ヒーロー - 難易度設定版
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const bgVideo = document.getElementById('bg-video');
const startBtn = document.getElementById('start-btn');
const ytLoadBtn = document.getElementById('yt-load-btn');
const ytShareBtn = document.getElementById('yt-share-btn');
const retryBtn = document.getElementById('retry-btn');
const startScreen = document.getElementById('start-screen');
const resultScreen = document.getElementById('result-screen');
const scoreVal = document.getElementById('score-val');
const comboText = document.getElementById('combo-text');
const judgmentText = document.getElementById('judgment-text');
const mediaUpload = document.getElementById('media-upload');
const ytStatus = document.getElementById('yt-status');
const ytContainer = document.getElementById('youtube-player-container');
const diffSelector = document.getElementById('diff-selector');

// 設定
const LANE_COUNT = 4;
const KEY_MAP = { 'arrowleft': 0, 'arrowdown': 1, 'arrowup': 2, 'arrowright': 3 };
const JUDGMENT_MS = { PERFECT: 60, GREAT: 110, GOOD: 160, MISS: 250 };
const HIT_LINE_Y = 0.82;
const COLORS = ['#00f2ff', '#ff007a', '#bcff00', '#9d00ff'];

// 難易度ごとのパラメータ
const DIFFICULTY_CONFIG = {
    easy:   { speed: 0.45, interval: 450, prob: 0.35 },
    normal: { speed: 0.60, interval: 300, prob: 0.45 },
    hard:   { speed: 0.75, interval: 220, prob: 0.55 },
    expert: { speed: 0.95, interval: 160, prob: 0.65 }
};

// ゲーム状態
let currentDiff = 'normal';
let gameState = 'START';
let playMode = 'NONE'; 
let score = 0, combo = 0, maxCombo = 0;
let notes = [];
let gameStartTime = 0;
let stats = { perfect: 0, great: 0, good: 0, miss: 0 };
let activeLanes = [false, false, false, false];
let particles = [];
let currentVideoId = "";
let currentDuration = 0;

// 難易度選択イベント
diffSelector.addEventListener('click', (e) => {
    if (e.target.classList.contains('diff-btn')) {
        document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        currentDiff = e.target.dataset.diff;
        
        // 既にメディアが読み込まれている場合は譜面を再生成
        if (currentDuration > 0) {
            notes = generateMap(currentDuration);
        }
    }
});

// オーディオシステム
let audioCtx, analyser, frequencyData, audioBuffer, audioSource;
let ytPlayer;

function initAudioContext() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        frequencyData = new Uint8Array(analyser.frequencyBinCount);
    }
}

// ファイルアップロード
mediaUpload.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('file-name').innerText = file.name;
    const isVideo = file.type.startsWith('video/');
    startBtn.disabled = true;
    ytShareBtn.classList.add('hidden');

    if (isVideo) {
        playMode = 'FILE_VIDEO';
        bgVideo.src = URL.createObjectURL(file);
        bgVideo.onloadedmetadata = () => {
            currentDuration = bgVideo.duration;
            notes = generateMap(currentDuration);
            startBtn.disabled = false;
            startBtn.innerText = "動画でプレイ開始！";
            bgVideo.classList.remove('hidden');
            ytContainer.classList.add('hidden');
        };
    } else {
        playMode = 'FILE_AUDIO';
        initAudioContext();
        try {
            const arrayBuffer = await file.arrayBuffer();
            audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            currentDuration = audioBuffer.duration;
            notes = generateMap(currentDuration);
            startBtn.disabled = false;
            startBtn.innerText = "音楽でプレイ開始！";
            bgVideo.classList.add('hidden');
            ytContainer.classList.add('hidden');
        } catch (err) {
            alert("オーディオの解析に失敗しました。");
        }
    }
});

// YouTube 読み込み
function loadYoutube(vidId) {
    currentVideoId = vidId;
    ytStatus.innerHTML = '<div class="loader"></div>';
    if (ytPlayer && ytPlayer.destroy) {
        try { ytPlayer.destroy(); } catch (e) {}
        ytContainer.innerHTML = '<div id="yt-player"></div>';
    }
    ytContainer.classList.remove('hidden');
    const safeOrigin = window.location.protocol === 'file:' ? 'https://www.youtube.com' : window.location.origin;

    ytPlayer = new YT.Player('yt-player', {
        height: '100%', width: '100%', videoId: vidId,
        playerVars: { 'autoplay': 0, 'controls': 1, 'origin': safeOrigin, 'enablejsapi': 1 },
        events: {
            'onReady': (e) => {
                const duration = e.target.getDuration();
                if (duration === 0) { ytStatus.innerText = "再生制限のある動画です。"; return; }
                currentDuration = duration;
                notes = generateMap(currentDuration);
                playMode = 'YOUTUBE';
                ytStatus.innerText = "読み込み完了！";
                startBtn.disabled = false;
                startBtn.innerText = "YouTubeでプレイ開始！";
                ytShareBtn.classList.remove('hidden');
            },
            'onError': () => { ytStatus.innerText = "エラーが発生しました。"; }
        }
    });
}

ytLoadBtn.addEventListener('click', () => {
    const vidId = extractYoutubeId(document.getElementById('yt-url').value);
    if (vidId) loadYoutube(vidId); else ytStatus.innerText = "無効なURLです。";
});

ytShareBtn.addEventListener('click', () => {
    const shareUrl = `${window.location.origin}${window.location.pathname}?v=${currentVideoId}`;
    const tempInput = document.createElement("input");
    tempInput.value = shareUrl;
    document.body.appendChild(tempInput); tempInput.select();
    document.execCommand("copy"); document.body.removeChild(tempInput);
    showToast("共有リンクをコピーしました！");
});

function showToast(msg) {
    const toast = document.createElement("div");
    toast.className = "toast"; toast.innerText = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
}

function extractYoutubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

function generateMap(durationSeconds) {
    const map = [];
    const config = DIFFICULTY_CONFIG[currentDiff];
    const totalMs = durationSeconds * 1000;
    
    // 難易度設定に基づいた譜面生成
    for (let t = 2500; t < totalMs - 2000; t += config.interval) {
        if (Math.random() < config.prob) {
            map.push({ time: t, lane: Math.floor(Math.random() * LANE_COUNT), hit: false });
            
            // Expertのみ同時押しの確率を追加
            if (currentDiff === 'expert' && Math.random() < 0.2) {
                map.push({ time: t, lane: (Math.floor(Math.random() * LANE_COUNT)) % LANE_COUNT, hit: false });
            }
        }
    }
    return map;
}

function getCurrentTimeMs() {
    if (playMode === 'YOUTUBE' && ytPlayer?.getCurrentTime) {
        try { return ytPlayer.getCurrentTime() * 1000; } catch(e) { return 0; }
    }
    if (playMode === 'FILE_VIDEO') return bgVideo.currentTime * 1000;
    if (playMode === 'FILE_AUDIO') return (audioCtx.currentTime - gameStartTime) * 1000;
    return 0;
}

function handleKeyDown(key) {
    if (gameState !== 'PLAYING') return;
    const laneIdx = KEY_MAP[key.toLowerCase()];
    if (laneIdx !== undefined && !activeLanes[laneIdx]) {
        activeLanes[laneIdx] = true;
        document.getElementById(`btn-${laneIdx}`).classList.add('active');
        checkHit(laneIdx);
    }
}

function handleKeyUp(key) {
    const laneIdx = KEY_MAP[key.toLowerCase()];
    if (laneIdx !== undefined) {
        activeLanes[laneIdx] = false;
        document.getElementById(`btn-${laneIdx}`).classList.remove('active');
    }
}

function checkHit(laneIdx) {
    const now = getCurrentTimeMs();
    let closestNote = null;
    let minDiff = Infinity;

    for (let n of notes) {
        if (n.lane === laneIdx && !n.hit) {
            const diff = Math.abs(n.time - now);
            if (diff < minDiff) { minDiff = diff; closestNote = n; }
        }
    }

    if (closestNote && minDiff < JUDGMENT_MS.MISS) {
        let judg = "";
        let pts = 0;
        if (minDiff < JUDGMENT_MS.PERFECT) { judg = "Perfect"; pts = 1000; stats.perfect++; }
        else if (minDiff < JUDGMENT_MS.GREAT) { judg = "Great"; pts = 700; stats.great++; }
        else if (minDiff < JUDGMENT_MS.GOOD) { judg = "Good"; pts = 400; stats.good++; }

        if (judg) {
            closestNote.hit = true;
            score += pts;
            combo++;
            maxCombo = Math.max(combo, maxCombo);
            applyVisualHit(judg, laneIdx);
        }
    }
}

function applyVisualHit(judg, laneIdx) {
    scoreVal.innerText = score.toString().padStart(6, '0');
    judgmentText.innerText = judg;
    judgmentText.style.color = COLORS[laneIdx % COLORS.length];
    judgmentText.style.textShadow = `0 0 20px ${COLORS[laneIdx % COLORS.length]}`;
    
    judgmentText.style.transform = 'scale(1.5)';
    setTimeout(() => judgmentText.style.transform = 'scale(1)', 100);

    if (combo >= 3) {
        comboText.innerText = combo;
        comboText.style.opacity = "1";
        comboText.style.transform = "scale(1.2)";
        setTimeout(() => comboText.style.transform = "scale(1)", 50);
    }
    createParticles(laneIdx);
}

function createParticles(laneIdx) {
    const x = (laneIdx + 0.5) * (canvas.width / LANE_COUNT);
    const y = canvas.height * HIT_LINE_Y;
    const color = COLORS[laneIdx];
    for (let i = 0; i < 15; i++) {
        particles.push({
            x, y, 
            vx: (Math.random() - 0.5) * 20, 
            vy: (Math.random() - 0.5) * 20, 
            life: 1.0, 
            color: color
        });
    }
}

function draw() {
    if (gameState !== 'PLAYING') return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const now = getCurrentTimeMs();
    const laneWidth = canvas.width / LANE_COUNT;
    const hitY = canvas.height * HIT_LINE_Y;
    const config = DIFFICULTY_CONFIG[currentDiff];

    let pulse = Math.sin(Date.now() / 150) * 0.2 + 0.8;

    // レーン描画
    for (let i = 0; i < LANE_COUNT; i++) {
        ctx.fillStyle = activeLanes[i] ? `rgba(${i*50}, 242, 255, 0.2)` : 'rgba(255, 255, 255, 0.03)';
        ctx.fillRect(i * laneWidth, 0, laneWidth, canvas.height);
        
        ctx.strokeStyle = 'rgba(0, 242, 255, 0.1)';
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(i * laneWidth, 0); ctx.lineTo(i * laneWidth, canvas.height); ctx.stroke();

        const color = COLORS[i];
        ctx.shadowBlur = activeLanes[i] ? 20 : 5;
        ctx.shadowColor = color;
        ctx.strokeStyle = activeLanes[i] ? color : 'rgba(255, 255, 255, 0.2)';
        ctx.lineWidth = activeLanes[i] ? 5 : 2;
        ctx.beginPath();
        ctx.moveTo(i * laneWidth + 10, hitY); ctx.lineTo((i + 1) * laneWidth - 10, hitY);
        ctx.stroke();
        ctx.shadowBlur = 0;
    }

    // ノーツ描画 (難易度ごとのスピードを適用)
    notes.forEach(note => {
        if (note.hit) return;
        const timeDiff = note.time - now;
        const y = hitY - (timeDiff * config.speed);

        if (y > -100 && y < canvas.height + 100) {
            const color = COLORS[note.lane];
            ctx.fillStyle = color;
            ctx.shadowBlur = 15 * pulse;
            ctx.shadowColor = color;
            
            ctx.beginPath();
            const nx = note.lane * laneWidth + 15;
            const nw = laneWidth - 30;
            ctx.roundRect(nx, y - 12, nw, 24, 8);
            ctx.fill();

            ctx.fillStyle = "rgba(255,255,255,0.4)";
            ctx.beginPath();
            ctx.roundRect(nx + 5, y - 8, nw - 10, 6, 4);
            ctx.fill();

            ctx.shadowBlur = 0;
        }

        if (timeDiff < -JUDGMENT_MS.MISS && !note.hit) {
            note.hit = true;
            combo = 0; stats.miss++;
            judgmentText.innerText = "Miss"; judgmentText.style.color = "#666";
            judgmentText.style.textShadow = "none";
            comboText.style.opacity = "0";
        }
    });

    // パーティクル
    particles = particles.filter(p => p.life > 0);
    particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.shadowBlur = 10 * p.life;
        ctx.shadowColor = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, 2 + p.life * 4, 0, Math.PI*2); ctx.fill();
        p.x += p.vx; p.y += p.vy; p.vy += 0.5; 
        p.life -= 0.025;
    });
    ctx.globalAlpha = 1.0;
    ctx.shadowBlur = 0;

    let isEnded = false;
    if (playMode === 'YOUTUBE' && ytPlayer?.getPlayerState?.() === YT.PlayerState.ENDED) isEnded = true;
    if (playMode === 'FILE_VIDEO' && bgVideo.ended) isEnded = true;
    if (playMode === 'FILE_AUDIO' && audioBuffer && now > audioBuffer.duration * 1000 + 1000) isEnded = true;

    if (isEnded) endGame();
    else requestAnimationFrame(draw);
}

function startGame() {
    score = 0; combo = 0; maxCombo = 0;
    stats = { perfect: 0, great: 0, good: 0, miss: 0 };
    particles = [];
    scoreVal.innerText = "000000";
    judgmentText.innerText = "";
    comboText.style.opacity = "0";
    
    // ゲーム開始時に再度譜面を生成（最新の難易度設定を反映）
    notes = generateMap(currentDuration);

    startScreen.classList.add('hidden');
    resultScreen.classList.add('hidden');
    
    if (playMode === 'YOUTUBE' && ytPlayer) {
        try { ytPlayer.playVideo(); } catch(e) {}
    } else if (playMode === 'FILE_VIDEO') {
        bgVideo.currentTime = 0; bgVideo.play();
    } else if (playMode === 'FILE_AUDIO') {
        initAudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        audioSource = audioCtx.createBufferSource();
        audioSource.buffer = audioBuffer;
        audioSource.connect(analyser); analyser.connect(audioCtx.destination);
        gameStartTime = audioCtx.currentTime;
        audioSource.start(0);
    }

    gameState = 'PLAYING';
    requestAnimationFrame(draw);
}

function endGame() {
    gameState = 'FINISHED';
    resultScreen.classList.remove('hidden');
    document.getElementById('final-score').innerText = score.toLocaleString();
    document.getElementById('stats-detail').innerHTML = `
        <span style="color:var(--neon-cyan)">PERFECT: ${stats.perfect}</span><br>
        <span style="color:var(--neon-pink)">GREAT: ${stats.great}</span><br>
        <span style="color:var(--neon-lime)">GOOD: ${stats.good}</span><br>
        <span style="color:#666">MISS: ${stats.miss}</span><br><br>
        最大コンボ: <span style="color:white; font-size: 20px;">${maxCombo}</span><br>
        難易度: <span style="color:var(--neon-cyan)">${currentDiff.toUpperCase()}</span>
    `;
    if (audioSource) { try { audioSource.stop(); } catch(e){} }
}

window.addEventListener('keydown', (e) => handleKeyDown(e.key));
window.addEventListener('keyup', (e) => handleKeyUp(e.key));

document.querySelectorAll('.touch-btn').forEach(btn => {
    btn.addEventListener('touchstart', (e) => { e.preventDefault(); handleKeyDown(btn.dataset.key); });
    btn.addEventListener('touchend', (e) => { e.preventDefault(); handleKeyUp(btn.dataset.key); });
});

startBtn.addEventListener('click', startGame);
retryBtn.addEventListener('click', () => {
    resultScreen.classList.add('hidden');
    startScreen.classList.remove('hidden');
    if (ytPlayer?.stopVideo) ytPlayer.stopVideo();
    if (bgVideo) bgVideo.pause();
});

function resize() {
    const container = document.getElementById('game-container');
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
}
window.addEventListener('resize', resize);
resize();

const params = new URLSearchParams(window.location.search);
if (params.get('v')) {
    document.getElementById('yt-url').value = `https://www.youtube.com/watch?v=${params.get('v')}`;
    const wait = setInterval(() => {
        if (typeof YT !== 'undefined' && YT.Player) { loadYoutube(params.get('v')); clearInterval(wait); }
    }, 500);
}

if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
        if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
        this.moveTo(x + r, y);
        this.arcTo(x + w, y, x + w, y + h, r);
        this.arcTo(x + w, y + h, x, y + h, r);
        this.arcTo(x, y + h, x, y, r);
        this.arcTo(x, y, x + w, y, r);
        this.closePath(); return this;
    }
}
</script>
</body>
</html>
